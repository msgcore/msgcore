#!/bin/sh

# Block --no-verify flag
if [ "$HUSKY_SKIP_HOOKS" = "1" ] || echo "$@" | grep -q "\-\-no-verify"; then
  echo "❌ Error: --no-verify is blocked. All commits must pass pre-commit checks."
  exit 1
fi

# Detect Claude Code environment
ENV_INFO=""
if [ "$CLAUDECODE" = "1" ]; then
  ENV_INFO="🤖 Claude Code detected"
fi

# Require explicit confirmation for commit
if [ "$ALL_TESTS_PASS" != "true" ]; then
  echo ""
  echo "⚠️  PRE-COMMIT SAFETY CHECK"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  if [ -n "$ENV_INFO" ]; then
    echo "$ENV_INFO"
  fi
  echo ""
  echo "Before committing, ensure you have:"
  echo "  ✓ Written comprehensive tests for all changes"
  echo "  ✓ Verified all tests pass (unit + e2e)"
  echo "  ✓ Reviewed the code changes thoroughly"
  echo "  ✓ Updated documentation if needed"
  echo ""
  echo "To proceed with commit, run:"
  echo "  ALL_TESTS_PASS=true git commit -m \"your message\""
  echo ""
  echo "Note: If using AI tools, set 10m timeout (600000ms) to allow tests and build to complete"
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""
  exit 1
fi

npx lint-staged
